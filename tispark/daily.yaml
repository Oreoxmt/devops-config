version: 1
defaultRef: master

# where to add cron
tasks:
  - name: tispark-fmt
    taskType: common
    shellScript: |
      export LC_ALL=en_US.UTF-8
      export LANG=en_US.UTF-8
      export LANGUAGE=en_US.UTF-8
      mvn mvn-scalafmt_2.12:format -Dscalafmt.skip=false -B
      mvn com.coveo:fmt-maven-plugin:format -B
      git diff --quiet
      formatted="$?"
      if [[ "${formatted}" -eq 1 ]]
      then
      echo "code format error, please run the following commands:"
      echo "   mvn mvn-scalafmt_2.12:format -Dscalafmt.skip=false"
      echo "   mvn com.coveo:fmt-maven-plugin:format"
      exit 1
      fi
    buildEnv:
      image: hub.pingcap.net/jenkins/centos7_golang-1.13_java:latest
      request:
        cpu: 2
        mem: 4Gi
      limit:
        cpu: 2
        mem: 4Gi

  - name: tispark-build
    taskType: common
    shellScript: |
      archive_url=http://fileserver.pingcap.net/download/builds/pingcap/tispark/cache/tispark-m2-cache-latest.tar.gz
      if [ ! "\$(ls -A /maven/.m2/repository)" ]; then curl -sL \$archive_url | tar -zx -C /maven || true; fi
      mvn -T 1C clean package -Dmaven.test.skip=true -B
    buildEnv:
      image: hub.pingcap.net/jenkins/centos7_golang-1.13_java:latest
      request:
        cpu: 2
        mem: 4Gi
      limit:
        cpu: 2
        mem: 4Gi

  - name: daily-trigger-tispark-ingegration-test
    taskType: jenkins-it-trigger

notify:
  lark: [shiyuhang0, xuanyu66]